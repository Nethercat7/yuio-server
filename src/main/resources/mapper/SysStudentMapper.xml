<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.zfy.yuio.dao.SysStudentDao">
    <resultMap id="student" type="SysStudent">
        <id column="student_id" property="studentId"></id>
        <result column="student_name" property="studentName"></result>
        <result column="student_code" property="studentCode"></result>
        <result column="student_gender" property="studentGender"></result>
        <result column="student_phone" property="studentPhone"></result>
        <result column="student_status" property="studentStatus"></result>
        <result column="student_grade" property="studentGrade"></result>
        <result column="student_remark" property="studentRemark"></result>
        <result column="student_create_time" property="studentCreateTime"></result>
        <result column="student_class_id" property="studentClassId"></result>
        <association property="studentClass" javaType="SysClass">
            <id column="class_id" property="classId"></id>
            <result column="class_name" property="className"></result>
            <result column="class_status" property="classStatus"></result>
            <result column="class_grade" property="classGrade"></result>
        </association>
        <association property="studentMajor" javaType="SysMajor">
            <id column="major_id" property="majorId"></id>
            <result column="major_name" property="majorName"></result>
            <result column="major_status" property="majorStatus"></result>
        </association>
        <association property="studentCollege" javaType="SysCollege">
            <id column="college_id" property="collegeId"></id>
            <result column="college_name" property="collegeName"></result>
            <result column="college_status" property="collegeStatus"></result>
        </association>
        <association property="studentWork" javaType="SysWork">
            <id column="work_id" property="workId"></id>
            <result column="work_name" property="workName"></result>
        </association>
        <association property="studentCity" javaType="SysCity">
            <id column="city_id" property="cityId"></id>
            <result column="city_name" property="cityName"></result>
        </association>
        <association property="studentEmplInfo" javaType="WriteEmplInfo">
            <id column="empl_id" property="emplId"></id>
            <result column="empl_status" property="emplStatus"></result>
            <result column="empl_company" property="emplCompany"></result>
            <result column="empl_protocol" property="emplProtocol"></result>
            <result column="empl_plan" property="emplPlan"></result>
            <result column="empl_protocol_file" property="emplProtocolFile"></result>
        </association>
        <collection property="studentTutorsCode" ofType="String">
            <id column="user_code" property="String"></id>
        </collection>
        <collection property="studentTutorsName" ofType="String">
            <id column="user_name" property="String"></id>
        </collection>
    </resultMap>

    <insert id="add" parameterType="SysStudent">
        INSERT INTO sys_student(student_id,student_name,student_code,student_gender,student_phone,student_status,student_grade,
        student_remark,student_class_id,student_pwd,student_salt)
        VALUES (#{studentId},#{studentName},#{studentCode},#{studentGender},#{studentPhone},#{studentStatus},#{studentGrade},
        #{studentRemark},#{studentClassId},#{studentPwd},#{studentSalt})
    </insert>

    <select id="get" parameterType="QueryParams" resultMap="student">
        SELECT
        *
        FROM
        sys_student s
        LEFT JOIN sys_class cls ON s.student_class_id = cls.class_id
        LEFT JOIN sys_major m ON cls.class_major_id = m.major_id
        LEFT JOIN sys_college c ON m.major_college_id = c.college_id
        LEFT JOIN write_empl_info ei ON ei.empl_student_code = s.student_code
        LEFT JOIN sys_city city ON ei.empl_city_id = city.city_id
        LEFT JOIN sys_work w ON ei.empl_work_id = w.work_id
        LEFT JOIN sys_student_teacher st ON s.student_code = st.st_student_code
        LEFT JOIN sys_user u ON u.user_code = st.st_teacher_code
        WHERE
        1 =1
        <if test="studentId!=null">
            AND s.student_id=#{studentId}
        </if>
        <if test="orgId!=null">
            AND (
            cls.class_id=#{orgId}
            OR m.major_id=#{orgId}
            OR c.college_id=#{orgId}
            )
        </if>
        <if test="name!=null">
            AND s.student_name LIKE concat('%',#{name},'%')
        </if>
        <if test="grade!=0">
            AND cls.class_grade=#{grade}
        </if>
        <if test="emplStatus!=null">
            AND ei.empl_status=#{emplStatus}
        </if>
        <if test="emplWrite==0">
            AND ei.empl_status IS NULL
        </if>
        <if test="emplWrite==1">
            AND ei.empl_status IS NOT NULL
        </if>
    </select>

    <delete id="del" parameterType="Long">
        DELETE FROM sys_student
        WHERE student_id=#{id}
    </delete>

    <update id="upd" parameterType="SysStudent">
        UPDATE sys_student
        SET student_name=#{studentName},student_code=#{studentCode},student_gender=#{studentGender},student_phone=#{studentPhone},
        student_status=#{studentStatus},student_grade=#{studentGrade},student_remark=#{studentRemark},student_class_id=#{studentClassId}
        WHERE student_id=#{studentId}
    </update>

    <select id="getById" parameterType="Long" resultMap="student">
        SELECT
        *
        FROM
        sys_student s
        LEFT JOIN sys_class cls ON s.student_class_id = cls.class_id
        LEFT JOIN sys_major m ON cls.class_major_id = m.major_id
        LEFT JOIN sys_college c ON m.major_college_id = c.college_id
        LEFT JOIN write_empl_info ei ON ei.empl_student_code = s.student_code
        LEFT JOIN sys_city city ON ei.empl_city_id = city.city_id
        LEFT JOIN sys_work w ON ei.empl_work_id = w.work_id
        LEFT JOIN sys_student_teacher st ON s.student_code = st.st_student_code
        LEFT JOIN sys_user u ON u.user_code = st.st_teacher_code
        WHERE s.student_id=#{id}
    </select>

    <insert id="addRole" parameterType="Long">
        INSERT INTO sys_student_role(sr_student_id,sr_role_id)
        VALUES(#{studentId},#{roleId})
    </insert>

    <update id="updProfile" parameterType="SysStudent">
        UPDATE sys_student
        SET student_gender=#{studentGender},student_phone=#{studentPhone}
        WHERE student_id=#{studentId}
    </update>

    <select id="getPwdInfo" parameterType="Long" resultType="SysStudent">
        SELECT student_pwd,student_salt
        FROM sys_student
        WHERE student_id=#{id}
    </select>

    <insert id="addFromExcel" parameterType="ExcelStudent">
        INSERT INTO sys_student(student_id,student_name,student_code,student_gender,student_phone,student_status,student_grade,student_remark,student_class_id,student_pwd,student_salt)
        VALUES
            <foreach collection="params" item="s" separator=",">
                (#{s.studentId},#{s.studentName},#{s.studentCode},#{s.studentGender},#{s.studentPhone},#{s.studentStatus},#{s.studentGrade},#{s.studentRemark},#{s.studentClassId},#{s.studentPwd},#{s.studentSalt})
            </foreach>
        </insert>

    <select id="verify" parameterType="String" resultType="Long">
        SELECT student_id
        FROM sys_student
        WHERE student_code=#{key}
        OR student_phone=#{key}
    </select>

    <insert id="addTutor" parameterType="String">
        INSERT INTO sys_student_teacher(st_teacher_code,st_student_code)
        VALUES
        <foreach collection="teacherCode" item="item" separator=",">
            (#{item},#{studentCode})
        </foreach>
    </insert>

    <select id="getTutorCode" parameterType="String" resultType="String">
        SELECT u.user_code FROM sys_user u
        LEFT JOIN sys_student_teacher st
        ON u.user_code=st.st_teacher_code
        LEFT JOIN sys_student s
        ON s.student_code=st.st_student_code
        WHERE s.student_code=#{code}
    </select>

    <select id="getTutorName" parameterType="String" resultType="String">
        SELECT u.user_name FROM sys_user u
        LEFT JOIN sys_student_teacher st
        ON u.user_code=st.st_teacher_code
        LEFT JOIN sys_student s
        ON s.student_code=st.st_student_code
        WHERE s.student_code=#{code}
    </select>
</mapper>